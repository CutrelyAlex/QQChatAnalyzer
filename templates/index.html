<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QQ聊天记录分析系统</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style-pro-readable.css') }}">
    <!-- Chart.js用于绘制图表 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <!-- vis.js用于社交网络可视化 -->
    <script src="https://cdn.jsdelivr.net/npm/vis-network@9.1.2/dist/vis-network.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- 顶部导航栏 -->
        <header class="header">
            <div class="header-content">
                <h1 class="app-title">💬 QQ聊天记录分析系统</h1>
                <div class="header-controls">
                    <button id="theme-toggle-btn" class="btn btn-secondary theme-toggle-btn" type="button" title="切换为更易阅读的风格">
                        易读风格
                    </button>
                    <div class="status-indicator">
                        <span id="ai-status" class="status-badge disabled">AI离线</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- 文件选择面板 -->
        <section class="file-panel">
            <div class="panel-header">
                <h2>📁 选择要分析的文件</h2>
            </div>
            <div class="panel-body">
                <div class="file-selector">
                    <select id="file-select" class="file-input">
                        <option value="">-- 选择文件 --</option>
                    </select>
                    <button id="load-btn" class="btn btn-primary">加载文件</button>
                </div>
                <div id="load-status" class="status-message"></div>
                <div class="file-info">
                    <span id="loaded-file" class="info-label">未加载文件</span>
                </div>
            </div>
        </section>

        <!-- 主功能：左侧导航 + 右侧内容（保持原有 tab-button / tab-pane / id，不改变功能） -->
        <div class="tabs-container layout-pro">
            <div class="tabs-header" aria-label="主功能导航">
                <div class="sidebar-title">主功能</div>
                <button class="tab-button active" data-tab="personal">👤 个人分析</button>
                <button class="tab-button" data-tab="group">👥 群体分析</button>
                <button class="tab-button" data-tab="network">🕸️ 社交网络</button>
                <button class="tab-button" data-tab="preview">📋 聊天预览</button>
                <button class="tab-button" data-tab="compare">🆚 对比</button>
                <button class="tab-button" data-tab="ai-config">🤖 AI总结</button>
                <button class="tab-button" data-tab="export">📊 导出报告(暂不支持)</button>
            </div>

            <div class="tabs-content">
                <!-- 个人分析标签页 -->
                <div class="tab-pane active" id="personal-tab">
                    <div class="tab-header">
                        <h2>个人分析</h2>
                        <p class="tab-description">分析特定成员的聊天活动、消息内容、互动行为等</p>
                    </div>
                    <div class="tab-body">
                        <div class="analysis-toolbar">
                            <div class="input-group" style="margin-bottom: 0;">
                                <label for="qq-input">成员查询:</label>
                                <input type="text" id="qq-input" placeholder="输入：uin/uid/成员ID/昵称（支持模糊匹配），或从下拉选择" list="qq-list">
                                <datalist id="qq-list"></datalist>
                                <button id="personal-analyze-btn" class="btn btn-primary" disabled>
                                    分析个人
                                </button>
                                <button id="save-personal-cache-btn" class="btn btn-secondary" style="display: none;">
                                    💾 保存分析数据
                                </button>
                            </div>

                            <!-- 分析进度条 -->
                            <div id="personal-progress" class="progress-container" style="display: none; margin-top: 10px;">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="personal-progress-fill"></div>
                                </div>
                                <div class="progress-text" id="personal-progress-text">正在分析中...</div>
                            </div>
                        </div>

                        <div class="subtabs" data-scope="personal" aria-label="个人分析子功能">
                            <button class="subtab is-active" type="button" data-subtab="overview">概览</button>
                            <button class="subtab" type="button" data-subtab="trend">趋势</button>
                            <button class="subtab" type="button" data-subtab="content">内容</button>
                            <button class="subtab is-disabled" type="button" data-subtab="insights" title="规划中">洞察</button>
                        </div>

                        <div class="subtab-panels">
                                    <section class="subtab-panel" data-scope="personal" data-subtab-panel="overview">
                                        <div id="personal-stats" class="stats-container" style="display: none;">
                                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-icon">👤</div>
                                    <div class="stat-content">
                                        <div class="stat-label">成员</div>
                                        <div class="stat-value" id="stat-display-name">-</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">🔑</div>
                                    <div class="stat-content">
                                        <div class="stat-label">uin</div>
                                        <div class="stat-value" id="stat-uin">-</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">💬</div>
                                    <div class="stat-content">
                                        <div class="stat-label">总发言次数</div>
                                        <div class="stat-value" id="stat-messages">-</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">📅</div>
                                    <div class="stat-content">
                                        <div class="stat-label">活跃天数</div>
                                        <div class="stat-value" id="stat-active-days">-</div>
                                    </div>
                                </div>

                                <div class="stat-card">
                                    <div class="stat-icon">🟢</div>
                                    <div class="stat-content">
                                        <div class="stat-label">首次发言</div>
                                        <div class="stat-value" id="stat-first-message-date">-</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">🔴</div>
                                    <div class="stat-content">
                                        <div class="stat-label">最后发言</div>
                                        <div class="stat-value" id="stat-last-message-date">-</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">🧼</div>
                                    <div class="stat-content">
                                        <div class="stat-label">有文本消息(干净)</div>
                                        <div class="stat-value" id="stat-clean-text-msgs">-</div>
                                    </div>
                                </div>

                                <div class="stat-card">
                                    <div class="stat-icon">⏰</div>
                                    <div class="stat-content">
                                        <div class="stat-label">最活跃时段</div>
                                        <div class="stat-value" id="stat-peak-time">-</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">📈</div>
                                    <div class="stat-content">
                                        <div class="stat-label">连续发言记录</div>
                                        <div class="stat-value" id="stat-max-streak">-</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">🔗</div>
                                    <div class="stat-content">
                                        <div class="stat-label">@互动次数</div>
                                        <div class="stat-value" id="stat-at-count">-</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">🏷️</div>
                                    <div class="stat-content">
                                        <div class="stat-label">被@次数</div>
                                        <div class="stat-value" id="stat-being-at-count">-</div>
                                    </div>
                                </div>

                                <div class="stat-card">
                                    <div class="stat-icon">↩️</div>
                                    <div class="stat-content">
                                        <div class="stat-label">回复次数</div>
                                        <div class="stat-value" id="stat-reply-count">-</div>
                                    </div>
                                </div>

                                <div class="stat-card">
                                    <div class="stat-icon">📝</div>
                                    <div class="stat-content">
                                        <div class="stat-label">平均字数(干净)</div>
                                        <div class="stat-value" id="stat-avg-length">-</div>
                                    </div>
                                </div>

                                <div class="stat-card">
                                    <div class="stat-icon">🔤</div>
                                    <div class="stat-content">
                                        <div class="stat-label">总字数(干净)</div>
                                        <div class="stat-value" id="stat-total-chars">-</div>
                                    </div>
                                </div>

                                <div class="stat-card">
                                    <div class="stat-icon">🖼️</div>
                                    <div class="stat-content">
                                        <div class="stat-label">图片元素</div>
                                        <div class="stat-value" id="stat-image-count">-</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">😄</div>
                                    <div class="stat-content">
                                        <div class="stat-label">表情元素</div>
                                        <div class="stat-value" id="stat-emoji-count">-</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">🔁</div>
                                    <div class="stat-content">
                                        <div class="stat-label">转发元素</div>
                                        <div class="stat-value" id="stat-forward-count">-</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">📎</div>
                                    <div class="stat-content">
                                        <div class="stat-label">文件元素</div>
                                        <div class="stat-value" id="stat-file-count">-</div>
                                    </div>
                                </div>

                                <div class="stat-card">
                                    <div class="stat-icon">🔗</div>
                                    <div class="stat-content">
                                        <div class="stat-label">链接次数</div>
                                        <div class="stat-value" id="stat-link-count">-</div>
                                    </div>
                                </div>

                                <div class="stat-card">
                                    <div class="stat-icon">🧾</div>
                                    <div class="stat-content">
                                        <div class="stat-label">系统事件</div>
                                        <div class="stat-value" id="stat-system-count">-</div>
                                    </div>
                                </div>

                                <div class="stat-card">
                                    <div class="stat-icon">↩️</div>
                                    <div class="stat-content">
                                        <div class="stat-label">撤回数</div>
                                        <div class="stat-value" id="stat-recall-count">-</div>
                                    </div>
                                </div>
                                            </div>

                                            <div class="chart-container" style="margin-top: 12px;">
                                                <h3>结构化元素统计（ElementType）</h3>
                                                <div id="personal-element-stats" class="kv-grid"></div>
                                            </div>
                                        </div>
                                    </section>

                                    <section class="subtab-panel" data-scope="personal" data-subtab-panel="trend" hidden>
                                        <div id="personal-trends" style="display: none;">
                                            <div class="module-grid">
                                                <div class="chart-container">
                                                    <h3>时段分布</h3>
                                                    <canvas id="time-dist-chart"></canvas>
                                                </div>
                                                <div class="chart-container">
                                                    <h3>月发言趋势</h3>
                                                    <canvas id="weekly-chart"></canvas>
                                                </div>
                                                <div class="chart-container">
                                                    <h3>星期分布</h3>
                                                    <canvas id="weekday-chart"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </section>

                                    <section class="subtab-panel" data-scope="personal" data-subtab-panel="content" hidden>
                                        <div id="personal-content" style="display: none;">
                                            <div class="module-grid">
                                                <div class="chart-container">
                                                    <h3>🔥 个人热词榜</h3>
                                                    <div id="personal-hot-words" class="hot-words-container"></div>
                                                </div>

                                                <div class="chart-container">
                                                    <h3>🤝 互动对象 Top</h3>
                                                    <div id="personal-top-interactions" class="simple-list"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </section>
                        </div>
                    </div>
                </div>

                <!-- 群体分析标签页 -->
                <div class="tab-pane" id="group-tab">
                    <div class="tab-header">
                        <h2>群体分析</h2>
                        <p class="tab-description">分析整个群的活动趋势、成员排行、热门话题等</p>
                    </div>
                    <div class="tab-body">
                        <div class="analysis-toolbar">
                            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                <button id="group-analyze-btn" class="btn btn-primary">分析群体数据</button>
                                <button id="save-group-cache-btn" class="btn btn-secondary" style="display: none;">💾 保存分析数据</button>
                            </div>

                            <!-- 分析进度条 -->
                            <div id="group-progress" class="progress-container" style="display: none; margin-top: 10px;">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="group-progress-fill"></div>
                                </div>
                                <div class="progress-text" id="group-progress-text">正在分析中...</div>
                            </div>
                        </div>

                        <div class="subtabs" data-scope="group" aria-label="群体分析子功能">
                            <button class="subtab is-active" type="button" data-subtab="overview">概览</button>
                            <button class="subtab" type="button" data-subtab="trend">趋势</button>
                            <button class="subtab" type="button" data-subtab="members">成员</button>
                            <button class="subtab" type="button" data-subtab="content">内容</button>
                        </div>

                        <div class="subtab-panels">
                                    <section class="subtab-panel" data-scope="group" data-subtab-panel="overview">
                                        <div id="group-stats" class="stats-container" style="display: none;">
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-icon">💬</div>
                                    <div class="stat-content">
                                        <div class="stat-label">总消息数</div>
                                        <div class="stat-value" id="stat-total-messages">-</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">👥</div>
                                    <div class="stat-content">
                                        <div class="stat-label">参与成员</div>
                                        <div class="stat-value" id="stat-members">-</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">📊</div>
                                    <div class="stat-content">
                                        <div class="stat-label">日均消息</div>
                                        <div class="stat-value" id="stat-daily-avg">-</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">🔥</div>
                                    <div class="stat-content">
                                        <div class="stat-label">最活跃时段</div>
                                        <div class="stat-value" id="stat-peak-hour">-</div>
                                    </div>
                                </div>
                            </div>

                            <div class="chart-container" style="margin-top: 12px;">
                                <h3>结构化元素统计（ElementType）</h3>
                                <div id="group-element-stats" class="kv-grid"></div>
                            </div>

                            <!-- 结构化元数据统计 -->
                            <div class="stats-grid" style="margin-top: 10px;">
                                <div class="stat-card">
                                    <div class="stat-icon">🧾</div>
                                    <div class="stat-content">
                                        <div class="stat-label">系统事件</div>
                                        <div class="stat-value" id="stat-system-messages">-</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">🗑️</div>
                                    <div class="stat-content">
                                        <div class="stat-label">撤回消息</div>
                                        <div class="stat-value" id="stat-recalled-messages">-</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">@</div>
                                    <div class="stat-content">
                                        <div class="stat-label">含@提及</div>
                                        <div class="stat-value" id="stat-mention-messages">-</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">↩️</div>
                                    <div class="stat-content">
                                        <div class="stat-label">回复消息</div>
                                        <div class="stat-value" id="stat-reply-messages">-</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">📎</div>
                                    <div class="stat-content">
                                        <div class="stat-label">含媒体/附件</div>
                                        <div class="stat-value" id="stat-media-messages">-</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 新增：谁最多（带数值） -->
                            <div class="stats-grid" style="margin-top: 10px;">
                                <div class="stat-card">
                                    <div class="stat-icon">🗑️</div>
                                    <div class="stat-content">
                                        <div class="stat-label">最常撤回</div>
                                        <div class="stat-value" id="stat-top-recaller">-</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">🖼️</div>
                                    <div class="stat-content">
                                        <div class="stat-label">发图片最多</div>
                                        <div class="stat-value" id="stat-top-image-sender">-</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">🙂</div>
                                    <div class="stat-content">
                                        <div class="stat-label">发表情最多</div>
                                        <div class="stat-value" id="stat-top-emoji-sender">-</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">🔁</div>
                                    <div class="stat-content">
                                        <div class="stat-label">转发最多</div>
                                        <div class="stat-value" id="stat-top-forward-sender">-</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">📄</div>
                                    <div class="stat-content">
                                        <div class="stat-label">发文件最多</div>
                                        <div class="stat-value" id="stat-top-file-sender">-</div>
                                    </div>
                                </div>

                                <div class="stat-card">
                                    <div class="stat-icon">🧧</div>
                                    <div class="stat-content">
                                        <div class="stat-label">红包/钱包最多</div>
                                        <div class="stat-value" id="stat-top-wallet-sender">-</div>
                                    </div>
                                </div>
                            </div>
                                        </div>
                                    </section>

                                    <section class="subtab-panel" data-scope="group" data-subtab-panel="trend" hidden>
                                        <div id="group-trends" style="display: none;">
                                            <div class="module-grid">
                                                <div class="chart-container">
                                                    <h3>月度消息趋势</h3>
                                                    <canvas id="monthly-trend-chart"></canvas>
                                                </div>
                                                <div class="chart-container">
                                                    <h3>消息类型分布</h3>
                                                    <canvas id="message-type-chart"></canvas>
                                                </div>
                                                <div class="chart-container">
                                                    <h3>全年各星期的某天消息统计</h3>
                                                    <div id="weekday-totals" class="weekday-totals-chart"></div>
                                                    <canvas id="weekday-totals-chart"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </section>

                                    <section class="subtab-panel" data-scope="group" data-subtab-panel="members" hidden>
                                        <div id="group-members" style="display: none;">
                                            <div class="module-grid">
                                                <div class="chart-container">
                                                    <h3>各种最多的人（含结构化/元素）</h3>
                                                    <div id="group-top-metrics" class="simple-list"></div>
                                                </div>

                                                <div class="chart-container">
                                                    <h3>成员活跃排行</h3>
                                                    <canvas id="member-ranking-chart"></canvas>
                                                </div>

                                                <!-- 新增：时段活跃分析 -->
                                                <div class="chart-container span-2">
                                                    <h3>每小时最活跃用户</h3>
                                                    <div id="hourly-top-users" class="time-analysis-grid"></div>
                                                </div>

                                                <div class="chart-container span-2">
                                                    <h3>每周各日最活跃用户</h3>
                                                    <div id="weekday-top-users" class="weekday-analysis"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </section>

                                    <section class="subtab-panel" data-scope="group" data-subtab-panel="content" hidden>
                                        <div id="group-content" style="display: none;">
                                            <div class="module-grid">
                                                <div class="chart-container span-2">
                                                    <h3>🔥 群热词榜</h3>
                                                    <div id="group-hot-words" class="hot-words-container"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </section>
                        </div>
                    </div>
                </div>

                <!-- 社交网络标签页 -->
                <div class="tab-pane" id="network-tab">
                    <div class="tab-header">
                        <h2>社交网络分析</h2>
                        <p class="tab-description">可视化成员之间的互动关系网络</p>
                    </div>
                    <div class="tab-body">
                        <div class="analysis-toolbar">
                            <!-- 网络图控制面板 - 在分析前设置 -->
                            <div class="network-controls">
                                <div class="control-panel">
                                    <div class="control-group">
                                        <label class="control-label">
                                            <span class="control-icon">🔗</span>
                                            <span>最大节点数: <strong id="max-nodes-value">100</strong></span>
                                        </label>
                                        <input type="range" id="max-nodes-slider" class="control-slider" min="1" max="2000" value="100" step="1">
                                        <div class="control-range-labels">
                                            <span>1</span>
                                            <span>2000</span>
                                        </div>
                                    </div>

                                    <div class="control-group">
                                        <label class="control-label">
                                            <span class="control-icon">➡️</span>
                                            <span>最大边数: <strong id="max-edges-value">300</strong></span>
                                        </label>
                                        <input type="range" id="max-edges-slider" class="control-slider" min="100" max="9999" value="300" step="1">
                                        <div class="control-range-labels">
                                            <span>100</span>
                                            <span>9999</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="network-layout-actions" style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin: 10px 0;">
                                <button id="network-analyze-btn" class="btn btn-primary">生成网络图</button>
                                <button id="save-network-cache-btn" class="btn btn-secondary" style="display: none;">💾 保存分析数据</button>
                                <button id="layout-circle-btn" class="btn btn-secondary" type="button" title="圆形排布">圆形排布</button>
                                <button id="layout-tree-btn" class="btn btn-secondary" type="button" title="树状排布">树状排布(点击节点整理)</button>
                                <button id="layout-smart-btn" class="btn btn-secondary" type="button" title="智能排布">散落排布</button>

                                <div class="network-search" style="display: flex; gap: 8px; align-items: center; margin-left: auto;">
                                    <input id="network-node-search" class="network-search-input" type="text" placeholder="搜索昵称或QQ号..." autocomplete="off" />
                                    <button id="network-node-search-btn" class="btn btn-secondary" type="button" title="搜索并居中到对应节点">搜索居中</button>
                                </div>
                            </div>

                            <!-- 分析进度条 -->
                            <div id="network-progress" class="progress-container" style="display: none; margin-top: 10px;">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="network-progress-fill"></div>
                                </div>
                                <div class="progress-text" id="network-progress-text">正在分析中（会稍微久一些）...</div>
                            </div>
                        </div>

                        <div class="subtabs" data-scope="network" aria-label="网络分析子功能">
                            <button class="subtab" type="button" data-subtab="overview">概览</button>
                            <button class="subtab is-active" type="button" data-subtab="graph">网络图</button>
                            <button class="subtab" type="button" data-subtab="content">内容</button>
                        </div>

                        <div class="subtab-panels">
                                    <section class="subtab-panel" data-scope="network" data-subtab-panel="overview" hidden>
                                        <div id="network-stats" class="stats-container" style="display: none;">
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-icon">🔗</div>
                                    <div class="stat-content">
                                        <div class="stat-label">节点数</div>
                                        <div class="stat-value" id="stat-nodes">-</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">→</div>
                                    <div class="stat-content">
                                        <div class="stat-label">连接数</div>
                                        <div class="stat-value" id="stat-edges">-</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">⭐</div>
                                    <div class="stat-content">
                                        <div class="stat-label">最受欢迎成员</div>
                                        <div class="stat-value" id="stat-most-popular">-</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">🤝</div>
                                    <div class="stat-content">
                                        <div class="stat-label">最活跃互动对</div>
                                        <div class="stat-value" id="stat-active-pair">-</div>
                                    </div>
                                </div>
                            </div>
                                        </div>
                                    </section>

                                    <section class="subtab-panel" data-scope="network" data-subtab-panel="graph">
                                        <div id="network-graph-container" style="display: none;">
                                            <div id="network-graph" style="width: 100%; height: 600px; border: 1px solid #ddd; border-radius: 8px;"></div>
                                        </div>
                                    </section>

                                    <section class="subtab-panel" data-scope="network" data-subtab-panel="content" hidden>
                                        <div class="chart-container">
                                            <h3>说明</h3>
                                            <div style="color: #666;">可在顶部保存分析数据，供 AI 总结使用。</div>
                                        </div>
                                    </section>
                        </div>
                    </div>
                </div>

                <!-- 对比标签页（US3） -->
                <div class="tab-pane" id="compare-tab">
                    <div class="tab-header">
                        <h2>对比</h2>
                        <p class="tab-description">选择两段聊天并排对比关键指标（私聊也支持）</p>

                        <!-- 规划：双页分析模式（目前对比页已支持双列展示；未来可扩展到“群体双页/个人双页”） -->
                        <div class="subtabs" aria-label="对比子功能（规划）">
                            <div class="subtab is-active">指标对比</div>
                            <div class="subtab is-disabled">网络对比</div>
                            <div class="subtab is-disabled">热词对比</div>
                            <div class="subtab is-disabled">AI结论对比</div>
                        </div>
                    </div>
                    <div class="tab-body">
                        <div class="compare-panel">
                            <div class="compare-selectors">
                                <div class="input-group" style="flex-wrap: wrap; gap: 10px; align-items: center;">
                                    <label for="compare-left-file">左侧文件:</label>
                                    <select id="compare-left-file" class="select" style="min-width: 260px;"></select>

                                    <label for="compare-right-file">右侧文件:</label>
                                    <select id="compare-right-file" class="select" style="min-width: 260px;"></select>

                                    <button id="compare-run-btn" class="btn btn-primary">开始对比</button>
                                </div>
                                <div class="hint-text" style="margin-top: 6px; color: #666;">
                                    提示：对比会复用群体/网络分析逻辑；网络计算可能较慢，可在需要时再开启。
                                </div>
                            </div>

                            <div id="compare-progress" class="progress-container" style="display: none;">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="compare-progress-fill"></div>
                                </div>
                                <div class="progress-text" id="compare-progress-text">正在对比中...</div>
                            </div>

                            <div id="compare-result" class="compare-result" style="display: none;">
                                <div class="compare-columns">
                                    <div class="compare-col">
                                        <h3>左侧</h3>
                                        <div id="compare-left-summary" class="compare-summary"></div>
                                    </div>
                                    <div class="compare-col">
                                        <h3>右侧</h3>
                                        <div id="compare-right-summary" class="compare-summary"></div>
                                    </div>
                                </div>

                                <div class="compare-diff">
                                    <h3>差异</h3>
                                    <div id="compare-diff-table" class="compare-diff-table"></div>
                                    <h4 style="margin-top: 12px;">媒体类型差异</h4>
                                    <div id="compare-media-diff" class="compare-diff-table"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 聊天预览标签页 -->
                <div class="tab-pane" id="preview-tab">
                    <div class="tab-header">
                        <h2>聊天记录预览</h2>
                        <p class="tab-description">浏览和筛选聊天记录内容</p>

                        <!-- 规划：预览子功能 Tab（暂为UI占位，不影响现有功能） -->
                        <div class="subtabs" aria-label="预览子功能（规划）">
                            <div class="subtab is-active">列表</div>
                            <div class="subtab is-disabled">搜索</div>
                            <div class="subtab is-disabled">标注/标签</div>
                        </div>
                    </div>
                    <div class="tab-body">
                        <div class="preview-filters">
                            <div class="filter-group">
                                <label for="preview-date-filter">按日期筛选:</label>
                                <select id="preview-date-filter" class="filter-select">
                                    <option value="">-- 所有日期 --</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="preview-qq-filter">按成员筛选:</label>
                                <select id="preview-qq-filter" class="filter-select">
                                    <option value="">-- 所有成员 --</option>
                                </select>
                            </div>
                            <button id="preview-load-btn" class="btn btn-primary">加载记录</button>
                        </div>

                        <div id="preview-stats" class="preview-stats" style="display: none;">
                            <div class="stat-info">
                                <span>总记录: <strong id="preview-total">0</strong></span>
                                <span>当前页: <strong id="preview-current-page">1</strong></span>
                                <span>共 <strong id="preview-total-pages">1</strong> 页</span>
                            </div>
                        </div>

                        <div id="preview-records" class="preview-records" style="display: none;">
                            <table class="records-table">
                                <thead>
                                    <tr>
                                        <th style="width: 180px;">时间</th>
                                        <th style="width: 150px;">发言人</th>
                                        <th>消息内容</th>
                                    </tr>
                                </thead>
                                <tbody id="preview-records-body"></tbody>
                            </table>
                        </div>

                        <div id="preview-pagination" class="pagination" style="display: none;">
                            <button id="preview-prev-btn" class="btn btn-secondary">上一页</button>
                            <span id="preview-page-info">第 1 页</span>
                            <button id="preview-next-btn" class="btn btn-secondary">下一页</button>
                        </div>

                        <div id="preview-empty" class="empty-state" style="display: none;">
                            <p>⚠️ 没有找到匹配的记录</p>
                        </div>
                    </div>
                </div>

                <!-- AI配置标签页 -->
                <div class="tab-pane" id="ai-config-tab">
                    <div class="tab-header">
                        <h2>⚙️ 功能配置</h2>
                        <p class="tab-description">自定义AI总结的各项参数和高级设置</p>

                        <!-- 规划：AI 子功能 Tab（暂为UI占位，不影响现有功能） -->
                        <div class="subtabs" aria-label="AI 子功能（规划）">
                            <div class="subtab is-active">配置</div>
                            <div class="subtab is-disabled">缓存</div>
                            <div class="subtab is-disabled">生成</div>
                            <div class="subtab is-disabled">历史</div>
                        </div>
                    </div>
                    <div class="tab-body">
                        <!-- 基础配置 -->
                        <div class="config-section">
                            <h3>基础配置</h3>

                            <div class="config-group">
                                <label for="ai-enable-toggle">启用AI功能:</label>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="ai-enable-toggle" class="toggle-input" checked>
                                    <label for="ai-enable-toggle" class="toggle-label"></label>
                                    <span id="ai-status-text" class="status-text">✅ 已启用</span>
                                </div>
                            </div>

                            <div class="config-group">
                                <label for="ai-output-tokens">输出Token限制（报告长度）:</label>
                                <div class="slider-container">
                                    <input type="range" id="ai-output-tokens" class="config-slider" min="500" max="16384" value="4000" step="100">
                                    <span id="ai-output-tokens-value" class="slider-value">4000</span>
                                </div>
                                <small class="config-hint">控制AI生成报告的最大长度</small>
                            </div>

                            <div class="config-group">
                                <label for="ai-context-tokens">输入Token预算（聊天采样）:</label>
                                <div class="slider-container">
                                    <input type="range" id="ai-context-tokens" class="config-slider" min="5000" max="1000000" value="60000" step="5000">
                                    <span id="ai-context-tokens-value" class="slider-value">60000</span>
                                </div>
                                <small class="config-hint">用于聊天记录稀疏采样的Token预算，越大越能包含更多聊天内容</small>
                            </div>
                        </div>

                        <!-- 高级设置 -->
                        <div class="config-section">
                            <h3>高级设置</h3>
                            <button id="toggle-advanced" class="btn btn-secondary btn-small">展开高级设置</button>

                            <div id="advanced-settings" style="display: none; margin-top: 20px;">
                                <div class="config-group">
                                    <label for="ai-temperature">温度 (Temperature):</label>
                                    <div class="slider-container">
                                        <input type="range" id="ai-temperature" class="config-slider" min="0" max="2" value="0.7" step="0.1">
                                        <span id="ai-temperature-value" class="slider-value">0.7</span>
                                    </div>
                                    <small style="color: #999;">范围 0-2, 越低越稳定，越高越创意</small>
                                </div>

                                <div class="config-group">
                                    <label for="ai-top-p">Top P:</label>
                                    <div class="slider-container">
                                        <input type="range" id="ai-top-p" class="config-slider" min="0" max="1" value="0.9" step="0.05">
                                        <span id="ai-top-p-value" class="slider-value">0.9</span>
                                    </div>
                                    <small style="color: #999;">范围 0-1, 控制采样的多样性</small>
                                </div>

                                <div style="padding: 15px; background: #f5f5f5; border-radius: 6px; margin-bottom: 20px;"></div>
                            </div>
                        </div>

                        <!-- 配置操作 -->
                        <div class="config-actions" style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                            <button id="test-config-btn" class="btn btn-secondary">🧪 测试连接</button>
                        </div>

                        <!-- 配置状态 -->
                        <div id="config-status" class="config-status" style="display: none; margin-top: 20px;">
                            <div id="config-status-message"></div>
                        </div>

                        <!-- 分析缓存管理 -->
                        <div class="config-section" style="margin-top: 40px; padding-top: 30px; border-top: 2px solid #eee;">
                            <h3>分析数据缓存</h3>
                            <p style="color: #666; margin-bottom: 10px;">需要使用保存分析结果以供生成AI总结</p>
                            <p style="color: #1890ff; font-size: 13px; margin-bottom: 20px;">
                                💡 使用说明：先在「个人分析」「群体分析」或「社交网络」页面完成分析，点击「保存分析数据」，然后在下方点击「生成总结」
                            </p>

                            <div id="analysis-cache-list">
                                <p style="color: #999;">加载中...</p>
                            </div>
                        </div>

                        <!-- 进度和结果展示区域 -->
                        <div class="summary-section" style="margin-top: 40px; padding-top: 30px; border-top: 2px solid #eee;">
                            <h3>AI总结结果</h3>

                            <!-- 进度展示区域 -->
                            <div id="generation-progress-container" style="display: none; margin-top: 30px; padding: 20px; background: #f5f5f5; border-radius: 8px; border-left: 4px solid #4CAF50;">
                                <div class="progress-header">
                                    <h4 style="margin: 0 0 15px 0; color: #333;">⏳ 正在生成总结...</h4>
                                </div>

                                <!-- 加载动画 -->
                                <div style="text-align: center; margin: 20px 0; padding: 20px 0; border-bottom: 1px solid #ddd;">
                                    <div style="width: 50px; height: 50px; border: 4px solid #f0f0f0; border-top: 4px solid #4CAF50; border-radius: 50%; margin: 0 auto; animation: spin 1s linear infinite;"></div>
                                    <p style="margin: 15px 0 0 0; color: #666; font-size: 14px;">处理中，请稍候...</p>
                                </div>

                                <!-- 进度信息 -->
                                <div class="progress-info" style="margin-bottom: 15px;">
                                    <div class="progress-item">
                                        <small style="color: #999;">当前步骤</small>
                                        <div id="progress-step" style="font-size: 14px; color: #333; font-weight: 500;">正在初始化...</div>
                                    </div>
                                </div>

                                <!-- 流式消息展示区 -->
                                <div id="generation-stream" style="background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 300px; overflow-y: auto; padding: 12px; font-size: 13px; font-family: 'Courier New', monospace; line-height: 1.6; color: #333; margin-bottom: 15px;">
                                    <div class="stream-log"></div>
                                </div>

                                <!-- 取消按钮 -->
                                <div class="progress-actions" style="display: flex; gap: 10px;">
                                    <button id="cancel-generation-btn" class="btn btn-secondary btn-small">✕ 取消生成</button>
                                    <small id="generation-time" style="color: #999; align-self: center;"></small>
                                </div>
                            </div>

                            <!-- 成功展示区域 -->
                            <div id="generation-success-container" style="display: none; margin-top: 30px; padding: 20px; background: #f0f8f4; border-radius: 8px; border-left: 4px solid #4CAF50;">
                                <div style="margin-bottom: 15px;">
                                    <h4 style="margin: 0 0 10px 0; color: #2e7d32;">✅ 生成完成！</h4>
                                    <small id="generation-stats" style="color: #666;"></small>
                                </div>
                                <div id="summary-content-display" style="background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 500px; overflow-y: auto; padding: 15px; font-size: 14px; line-height: 1.8; color: #333; white-space: pre-wrap; word-break: break-word;"></div>
                                <div style="margin-top: 15px; display: flex; gap: 10px;">
                                    <button id="copy-summary-btn" class="btn btn-secondary btn-small">📋 复制内容</button>
                                    <button id="new-generation-btn" class="btn btn-secondary btn-small">🔄 重新生成</button>
                                </div>
                            </div>

                            <!-- 错误展示区域 -->
                            <div id="generation-error-container" style="display: none; margin-top: 30px; padding: 20px; background: #ffebee; border-radius: 8px; border-left: 4px solid #f44336;">
                                <div style="margin-bottom: 15px;">
                                    <h4 style="margin: 0 0 10px 0; color: #c62828;">❌ 生成失败</h4>
                                    <div id="error-message" style="color: #d32f2f; font-size: 13px; line-height: 1.6;"></div>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button id="retry-generation-btn" class="btn btn-secondary btn-small">🔁 重试</button>
                                    <button id="reset-generation-btn" class="btn btn-secondary btn-small">↺ 重置</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 导出报告标签页 -->
                <div class="tab-pane" id="export-tab">
                    <div class="tab-header">
                        <h2>导出报告</h2>
                        <p class="tab-description">将分析结果导出为HTML或PDF报告</p>

                        <!-- 规划：导出子功能 Tab（暂为UI占位，不影响现有功能） -->
                        <div class="subtabs" aria-label="导出子功能（规划）">
                            <div class="subtab is-active">格式</div>
                            <div class="subtab is-disabled">模板</div>
                            <div class="subtab is-disabled">批量</div>
                        </div>
                    </div>
                    <div class="tab-body">
                        <div class="export-options">
                            <div class="option-group">
                                <label>报告格式:</label>
                                <div class="radio-group">
                                    <label class="radio-item">
                                        <input type="radio" name="export-format" value="html" checked>
                                        <span>HTML (网页)</span>
                                    </label>
                                    <label class="radio-item">
                                        <input type="radio" name="export-format" value="pdf">
                                        <span>PDF (文档)</span>
                                    </label>
                                </div>
                            </div>

                            <div class="option-group">
                                <label>包含内容:</label>
                                <div class="checkbox-group">
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="export-content" value="personal" checked>
                                        <span>个人分析</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="export-content" value="group" checked>
                                        <span>群体分析</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="export-content" value="network" checked>
                                        <span>社交网络</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="export-content" value="ai-summary">
                                        <span>AI总结</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="action-group">
                            <button id="export-btn" class="btn btn-primary" disabled>📥 导出报告</button>
                        </div>

                        <div id="export-status" class="status-message"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI总结弹窗 -->
        <div id="summary-modal" class="modal" style="display: none;">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h2 id="summary-title">🤖 AI智能总结</h2>
                    <button class="close-btn" onclick="closeSummaryModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="summary-loading" class="loading" style="display: none;">
                        <div class="spinner"></div>
                        <p>🎨 正在生成创意报告，请稍候...</p>
                        <small style="color: #888;">正在生成创意报告...</small>
                    </div>
                    <div id="summary-content" style="display: none;">
                        <div class="summary-text-container">
                            <div id="summary-text" class="markdown-content"></div>
                        </div>
                        <div class="summary-metadata">
                            <small>
                                ⏱️ 生成时间: <span id="summary-time">-</span> |
                                📊 Token消耗: <span id="summary-tokens">-</span> |
                                🤖 模型: <span id="summary-model">-</span>
                            </small>
                        </div>
                    </div>
                    <div id="summary-error" class="error-message" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeSummaryModal()">关闭</button>
                    <button class="btn btn-primary" onclick="copySummary()">📋 复制内容</button>
                </div>
            </div>
        </div>

        <!-- 底部信息栏 -->
        <footer class="footer">
            <div class="footer-content">
                <div class="footer-info">
                    <span class="app-version">v1.0.0</span>
                    <span class="separator">|</span>
                    <span id="footer-status">就绪</span>
                </div>
                <div class="footer-disclaimer">
                    <span class="disclaimer-icon">⚖️</span>
                    <span class="disclaimer-text">请在加载文件前，确保你通过合法合规的QQ途径导出聊天记录，且已经征得所有群员同意进行分析；请在使用AI总结前，确保你知悉AI可能出错</span>
                </div>
            </div>
        </footer>
    </div>

    <!-- 模块化 JavaScript 文件 -->
    <script src="{{ url_for('static', filename='js/core.js') }}"></script>
    <script src="{{ url_for('static', filename='js/analysis-cache.js') }}"></script>
    <script src="{{ url_for('static', filename='js/file-handler.js') }}"></script>
    <script src="{{ url_for('static', filename='js/analyzer.js') }}"></script>
    <script src="{{ url_for('static', filename='js/compare.js') }}"></script>
    <script src="{{ url_for('static', filename='js/ai-summary.js') }}"></script>
    <script src="{{ url_for('static', filename='js/ui.js') }}"></script>
    <script src="{{ url_for('static', filename='js/network.js') }}"></script>
    <script src="{{ url_for('static', filename='js/hotwords.js') }}"></script>
    <script src="{{ url_for('static', filename='js/theme-toggle.js') }}"></script>
    <script src="{{ url_for('static', filename='js/config.js') }}"></script>
</body>
</html>
